# scPHcompare

`scPHcompare` is an R package that wraps a collection of scripts for computing persistent homology (PH) on single-cell RNA-seq datasets and for comparing the resulting topological summaries across many samples. The code originated as several standalone R files; the package now exposes the main workflow through the function `run_unified_pipeline()`.

## Features

* Preprocessing and integration of single-cell datasets using **Seurat**
* Calculation of persistence diagrams for each sample
* Generation of distance matrices (Bottleneck, Spectral and Landscape) for PH objects
* Multiple clustering approaches including standard Seurat, k-means, hierarchical PH and spectral clustering
* Post-processing modules include:
  * Cluster comparison with statistical metrics
  * Betti, Euler, and Landscape curve analysis
  * Cross‑iteration comparisons (executed automatically with the modular analysis)
* Helper utilities for plotting, caching and validating intermediate results
* `generate_toy_data()` helper for creating small synthetic datasets

## Installation

The package can be installed from a local checkout using `devtools`:

```r
# install.packages("devtools")
library(devtools)
install("path/to/scPHcompare")
library(scPHcompare)
```

`scPHcompare` depends on several Bioconductor and CRAN packages listed in the `DESCRIPTION` file. Make sure these are available in your R environment before running the pipeline.

## Quick start

Prepare a CSV file describing each dataset. The required columns are `File Path` and `Sample Name`. Additional metadata such as `SRA`, `Tissue` and `Approach` (scRNA‑seq or snRNA‑seq) will be preserved if provided. **At least one of `SRA`, `Tissue`, or `Approach` must be present to allow grouping and downstream analyses.** Column names can be customised when calling the pipeline. Approach labels are taken directly from the metadata and are no longer inferred automatically from expression metrics.

Currently, `scPHcompare` primarily reads expression matrices stored as `.RData` files. Many such datasets can be downloaded from [PanglaoDB](https://panglaodb.se). Support for other standard matrix formats is planned for a future release.

```r
results <- run_unified_pipeline(
  metadata_path = "metadata.csv",
  results_dir = "results",
  num_cores = 8,
  integration_method = "seurat",
  run_modular = TRUE,   # modular step incl. cross‑iteration comparisons
  run_cluster = TRUE,   # optional cluster metrics output
  run_betti = TRUE      # optional Betti curve comparison
)
```

The wrapper executes preprocessing and PH calculation first. If the optional modules are enabled the function `run_postprocessing_pipeline()` performs clustering, visualisation and distance matrix generation. Results such as Seurat objects and plots are written to the directory specified by `results_dir`.

Distance matrices can also be generated separately for each iteration by calling `process_iteration_calculate_matrices()` from `PH_PostProcessing_andAnalysis.R`.

## Toy Example Data

To try the package without obtaining real datasets, a small synthetic dataset can be generated directly in R:

```r
library(scPHcompare)
toy_files <- generate_toy_data()
```

This writes three sparse 100×50 matrices and a `metadata.csv` file to `inst/extdata/toy/` and returns their paths. The metadata can then be used to run the pipeline:

```r
results <- run_unified_pipeline(
  metadata_path = toy_files$metadata,
  results_dir = "toy_results",
  num_cores = 2
)
```

These toy data are randomly generated and very small. They are intended only for demonstrations and automated tests and should not be used for biological interpretation.

## Output overview

The pipeline creates several subfolders under `results_dir`. These are
initialised automatically when a step first writes output and are reused
in later runs:

* `seurat_objects/` – created by `run_postprocessing_pipeline()` when the
  processed Seurat object for an iteration is saved. Files are named
  `<iteration>_seurat_object.rds`, for example
  `results/seurat_objects/raw_seurat_object.rds`.
* `plots/` – generated by the visualisation routines. This directory
  contains UMAP plots, heatmaps and cluster comparison graphics. It also
  houses subfolders such as `withinIterationClusterComparison/` and
  `betti_plots/`. Example file:
  `results/plots/UMAP_Plots_Raw_All_Clusters.pdf`.
* `BDM_progress_*` – temporary progress files written while computing the
  Bottleneck distance matrix in `process_iteration_calculate_matrices()`.
  They allow the computation to resume if interrupted, e.g.
  `results/BDM_progress_Raw.rds`.
* `plots/betti_plots/betti_cache/` – cache directory for Betti curve
  computations. Each dataset gets its own subfolder with hashed cache
  files such as
  `results/plots/betti_plots/betti_cache/Raw/cache_abcd1234.rds`.

Pairwise statistics summarised across datasets are provided in CSV files under the `Result Tables/` directory of this repository.

## Functions exported

The package exports the following user facing functions:

* `run_unified_pipeline()` – entry point that runs preprocessing and optional post‑processing modules
* `run_postprocessing_pipeline()` – standalone function for clustering and analyses on existing PH results
* `run_modular_analysis()` – runs cluster comparison, Betti curves and cross‑iteration analysis
* `process_datasets_PH()` – lower level function performing PH calculations on input datasets


Refer to the documentation in the `R/` directory for details on additional parameters.

## Citation and license

This project is released under the MIT license (see `DESCRIPTION`). If you use `scPHcompare` in your work please cite the package and the persistent homology methods accordingly.
